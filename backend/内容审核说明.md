# 内容审核功能说明

## 📋 快速参考

| 项目 | 说明 |
|------|------|
| **功能** | 过滤用户自由输入中的违规内容 |
| **触发位置** | `/api/game/judge/stream` 端点（玩家自由输入时） |
| **审核模型** | 可配置独立轻量级模型（推荐 `gpt-4o-mini`） |
| **延迟** | 约 0.5-1 秒 |
| **成本** | 每次约 $0.0001-0.0002 |
| **失败策略** | 默认放行，不影响游戏 |
| **前端显示** | 黄色警告信息，可重新输入 |

## 功能概述

内容审核功能用于过滤用户输入中的违规内容，保护游戏内容的健康性。系统会在用户提交自由输入时自动检查内容是否包含：

- 色情、性暗示内容
- 极端暴力、血腥、虐待内容
- 仇恨言论、歧视性内容
- 违法犯罪相关内容

**注意**：由于游戏是末世生存题材，审核系统允许适度的暴力描写（如丧尸、战斗、受伤等），只拒绝明显违规的内容。

## 配置方法

### 1. 环境变量配置

在 `backend/.env` 文件中添加以下配置：

```env
# Moderator（内容审核）专用配置
MODERATOR_API_KEY=your_api_key_here
MODERATOR_BASE_URL=https://api.openai.com/v1
MODERATOR_MODEL=gpt-4o-mini
```

**推荐配置**：
- 使用轻量级模型（如 `gpt-4o-mini`、`gpt-3.5-turbo`）以降低延迟和成本
- 如果不配置专用模型，将使用通用配置（`OPENAI_*` 环境变量）

### 2. 配置示例

#### 使用通用配置
如果不设置 `MODERATOR_*` 变量，系统会自动使用通用配置：

```env
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o-mini
```

#### 使用专用轻量级模型
为了优化性能和成本，建议为审核功能配置专用的轻量级模型：

```env
# 通用配置（用于叙事和判定）
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o

# 审核专用配置（使用更便宜的模型）
MODERATOR_API_KEY=your_api_key_here
MODERATOR_BASE_URL=https://api.openai.com/v1
MODERATOR_MODEL=gpt-4o-mini
```

## 工作原理

### 1. 审核流程

```
用户输入 → 内容审核 → 通过 → 继续处理
                    ↓
                  拒绝 → 返回错误信息 → 前端显示警告 → 用户重新输入
```

### 2. 审核位置

目前审核功能集成在以下端点：

- **`POST /api/game/judge/stream`** - 玩家行动判定
  - 当玩家选择自由输入时，系统会先审核输入内容
  - 如果内容违规，返回错误信息，不会调用 Judge AI
  - 如果内容安全，正常处理玩家行动

### 3. 错误处理

- 如果审核服务出错（如网络问题、API异常），系统会**默认放行**，避免影响用户体验
- 审核失败会记录到日志中，便于排查问题

## 审核结果示例

### 安全内容（通过）
```
用户输入：我想用手电筒照亮前方的道路
审核结果：通过 ✓
```

### 违规内容（拒绝）
```
用户输入：[包含色情内容的文本]
审核结果：拒绝 ✗
返回信息：您的输入包含不适宜的内容，请重新输入。原因：包含色情内容
前端显示：⚠️ 您的输入包含不适宜的内容，请重新输入。原因：包含色情内容
```

**前端处理**：
- 错误信息以黄色高亮显示（`text-yellow-400`）
- 保持危机选项界面，允许用户重新选择或输入
- 不会影响游戏进度，用户可以立即重试
```

## 性能优化建议

1. **使用轻量级模型**
   - 推荐：`gpt-4o-mini`、`gpt-3.5-turbo`
   - 审核任务相对简单，不需要使用大模型

2. **调整温度参数**
   - 当前设置：`temperature=0.3`（较低温度，获得更稳定的判断）
   - 可以根据实际效果调整

3. **缓存优化**（未来可扩展）
   - 可以对常见的安全/违规输入进行缓存
   - 减少重复调用 API

## 日志记录

审核结果会记录到日志中：

```
[WARNING] 内容审核未通过 - 原因: 包含色情内容 - 输入: [用户输入前100字符]
```

## 自定义审核规则

如需调整审核规则，可以修改 `backend/app/moderator_service.py` 中的 `system_prompt`：

```python
self.system_prompt = """你是一个内容安全审核助手。你的任务是判断用户输入是否包含不适宜的内容。

需要拒绝的内容类型：
1. 色情、性暗示内容
2. 极端暴力、血腥、虐待内容
3. 仇恨言论、歧视性内容
4. 违法犯罪相关内容

注意：
- 本游戏是末世生存题材，允许适度的暴力描写（如丧尸、战斗、受伤等）
- 允许正常的情感表达和人际关系描写
- 只拒绝明显违规的内容

请以JSON格式返回审核结果：
{
    "is_safe": true/false,
    "reason": "违规原因（如果is_safe为false）"
}"""
```

## 测试建议

### 1. 测试安全内容（应该通过）
- ✅ "我用手电筒照亮前方的道路"
- ✅ "我拿起武器准备战斗"
- ✅ "我用医疗包治疗伤口"
- ✅ "我和幸存者分享食物"

### 2. 测试边界情况（应该通过）
- ✅ "我用刀砍杀了几只丧尸"
- ✅ "我看到地上有血迹"
- ✅ "我安慰受伤的队友"

### 3. 测试违规内容（应该拒绝）
- ❌ 明显的色情内容
- ❌ 极端暴力、虐待描写
- ❌ 仇恨言论

### 4. 前端测试流程
1. 进入游戏生存阶段
2. 遇到危机事件时，选择"E. 自由输入"
3. 输入测试内容
4. 观察结果：
   - **通过**：正常显示判定结果
   - **拒绝**：显示黄色警告信息，可以重新输入

## 常见问题

### Q: 审核会增加多少延迟？
A: 使用轻量级模型（如 `gpt-4o-mini`），通常增加 0.5-1 秒延迟。

### Q: 审核失败会影响游戏吗？
A: 不会。如果审核服务出错，系统会默认放行，确保游戏正常进行。

### Q: 可以关闭审核功能吗？
A: 可以。在 `backend/app/routers/game.py` 中注释掉审核相关代码即可。

### Q: 审核成本如何？
A: 使用 `gpt-4o-mini` 模型，每次审核成本约为 $0.0001-0.0002（取决于输入长度）。
