"""
æç¤ºè¯æ¨¡æ¿å’Œä¸Šä¸‹æ–‡ç»„ç»‡æ¨¡å—

è®¾è®¡åŸåˆ™ï¼š
1. æ¯ä¸ªAIè§’è‰²æœ‰ç‹¬ç«‹çš„ç³»ç»Ÿæç¤ºè¯ï¼Œå®šä¹‰å…¶äººæ ¼å’Œè¾“å‡ºæ ¼å¼
2. ä¸Šä¸‹æ–‡ç»„ç»‡ï¼šæˆªå–æœ€è¿‘3-5å¤©å†å²ï¼Œé¿å…tokenæµªè´¹
3. ç»“æ„åŒ–è¾“å‡ºï¼šè¦æ±‚AIè¿”å›JSONæ ¼å¼ï¼Œä¾¿äºè§£æ
"""
from app.models import Stats, InventoryItem, HistoryEntry, Shelter


# ==================== ä¸Šä¸‹æ–‡ç»„ç»‡å·¥å…·å‡½æ•° ====================

def format_stats(stats: Stats) -> str:
    """æ ¼å¼åŒ–ç©å®¶çŠ¶æ€"""
    return f"â¤ï¸ç”Ÿå‘½: {stats.hp}/100 | ğŸ”é¥±è…¹: {stats.hunger}/100 | ğŸ§ ç†æ™º: {stats.san}/100"


def format_inventory(inventory: list[InventoryItem]) -> str:
    """æ ¼å¼åŒ–èƒŒåŒ…ç‰©å“"""
    if not inventory:
        return "èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ"
    items = [f"- {item.name} x{item.count}" for item in inventory]
    return "\n".join(items)


def format_history(history: list[HistoryEntry], max_days: int = 5) -> str:
    """
    æ ¼å¼åŒ–å†å²è®°å½•ï¼Œåªå–æœ€è¿‘Nå¤©
    è¿™æ˜¯å…³é”®çš„ä¸Šä¸‹æ–‡å‹ç¼©ç­–ç•¥ï¼Œé¿å…tokençˆ†ç‚¸
    """
    if not history:
        return "è¿™æ˜¯æœ«ä¸–çš„ç¬¬ä¸€å¤©..."
    
    # åªå–æœ€è¿‘çš„max_dayså¤©
    recent = history[-max_days:] if len(history) > max_days else history
    
    lines = []
    for entry in recent:
        result_tag = f" [{entry.event_result}]" if entry.event_result != "none" else ""
        lines.append(f"ã€ç¬¬{entry.day}å¤©ã€‘{entry.log}{result_tag}")
    
    return "\n".join(lines)


def format_hidden_tags(tags: list[str]) -> str:
    """æ ¼å¼åŒ–éšè—æ ‡ç­¾ï¼ˆä»…ä¾›AIå‚è€ƒï¼Œä¸å±•ç¤ºç»™ç©å®¶ï¼‰"""
    if not tags:
        return "æ— "
    return ", ".join(tags)


# ==================== Narrator æç¤ºè¯ (å°è¯´å®¶/æ—ç™½) ====================

NARRATOR_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½æœ«ä¸–ç”Ÿå­˜æ¸¸æˆçš„æ—ç™½ï¼Œæ‰®æ¼”"å°è¯´å®¶"è§’è‰²ã€‚

## ä½ çš„äººæ ¼ç‰¹ç‚¹
- æ“…é•¿ç¯å¢ƒæå†™å’Œæ°›å›´è¥é€ 
- å–„äºåˆ¶é€ æ‚¬ç–‘æ„Ÿå’Œç´§å¼ æ„Ÿ
- æ³¨é‡å‰åå‰§æƒ…çš„è¿è´¯æ€§
- æ–‡å­—ç®€æ´æœ‰åŠ›ï¼Œåƒæ—¥è®°ä½“

## ä½ çš„ä»»åŠ¡
æ ¹æ®ç©å®¶å½“å‰çŠ¶æ€å’Œå†å²ï¼Œç”Ÿæˆä»Šå¤©çš„ç”Ÿå­˜æ—¥å¿—ã€‚ä½ éœ€è¦ï¼š
1. æè¿°ä»Šå¤©å‘ç”Ÿçš„äº‹æƒ…ï¼ˆ100-200å­—ï¼‰
2. åˆ¤æ–­ä»Šå¤©æ˜¯å¦æœ‰éœ€è¦ç©å®¶å†³ç­–çš„å±æœºäº‹ä»¶
3. å¦‚æœæœ‰å±æœºï¼Œç”Ÿæˆ4ä¸ªé€‰é¡¹ä¾›ç©å®¶é€‰æ‹©

## è¾“å‡ºæ ¼å¼è¦æ±‚
å¿…é¡»è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼ˆä¸è¦æœ‰å…¶ä»–å†…å®¹ï¼‰ï¼š
```json
{
  "log_text": "ä»Šæ—¥æ—¥å¿—å†…å®¹...",
  "has_crisis": trueæˆ–false,
  "choices": ["A. é€‰é¡¹1", "B. é€‰é¡¹2", "C. é€‰é¡¹3", "D. é€‰é¡¹4"] æˆ– null
}
```

## é‡è¦è§„åˆ™
- å¦‚æœhas_crisisä¸ºfalseï¼Œchoiceså¿…é¡»ä¸ºnull
- å¦‚æœhas_crisisä¸ºtrueï¼Œå¿…é¡»æä¾›4ä¸ªé€‰é¡¹
- é€‰é¡¹è¦åŸºäºç©å®¶å½“å‰æ‹¥æœ‰çš„ç‰©å“ï¼Œåˆç†ä¸”æœ‰åˆ›æ„
- æ³¨æ„ç©å®¶çš„éšè—æ ‡ç­¾ï¼Œå®ƒä»¬ä¼šå½±å“å‰§æƒ…èµ°å‘
- ç‰©èµ„å……è¶³æ—¶å¯ä»¥æå†™å®‰å¿ƒæ„Ÿï¼Œç‰©èµ„åŒ®ä¹æ—¶è¦åˆ¶é€ ç„¦è™‘
- ç†æ™º(SAN)ä½æ—¶ï¼Œæè¿°è¦æ›´åŠ é˜´éƒã€å‡ºç°å¹»è§‰æš—ç¤º"""


def build_narrator_prompt(
    day: int,
    stats: Stats,
    inventory: list[InventoryItem],
    hidden_tags: list[str],
    history: list[HistoryEntry],
    shelter: Shelter | None = None
) -> str:
    """
    æ„å»ºNarratorçš„ç”¨æˆ·æç¤ºè¯
    æ ¸å¿ƒï¼šç»„ç»‡ä¸Šä¸‹æ–‡ï¼Œè®©AIç†è§£å½“å‰æ¸¸æˆçŠ¶æ€
    """
    shelter_info = "æ— é¿éš¾æ‰€ï¼ˆéœ²å®¿è¡—å¤´ï¼‰"
    shelter_hidden_info = "æ— "
    if shelter is not None:
        defense_stars = "â˜…" * max(1, int(shelter.defense or 1))
        shelter_info = (
            f"{shelter.name} (ID: {shelter.id})\n"
            f"- é˜²å¾¡: {defense_stars}\n"
            f"- ç©ºé—´: {shelter.space}\n"
            f"- è¯´æ˜: {shelter.description}"
        )
        shelter_hidden_info = shelter.hidden_discription or "æ— "
    
    return f"""## å½“å‰æ¸¸æˆçŠ¶æ€

**ç¬¬ {day} å¤©**

### é¿éš¾æ‰€
{shelter_info}

### é¿éš¾æ‰€éšè—ä¿¡æ¯ï¼ˆä»…ä¾›AIå‚è€ƒï¼Œç©å®¶ä¸å¯è§ï¼‰
{shelter_hidden_info}

### ç©å®¶çŠ¶æ€
{format_stats(stats)}

### èƒŒåŒ…ç‰©å“
{format_inventory(inventory)}

### éšè—æ ‡ç­¾ï¼ˆå½±å“å‰§æƒ…ï¼Œç©å®¶ä¸å¯è§ï¼‰
{format_hidden_tags(hidden_tags)}

### æœ€è¿‘å‡ å¤©çš„ç»å†
{format_history(history)}

---
è¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆç¬¬{day}å¤©çš„ç”Ÿå­˜æ—¥å¿—ã€‚"""


# ==================== Judge æç¤ºè¯ (å†·é…·è£åˆ¤/DM) ====================

JUDGE_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½æœ«ä¸–ç”Ÿå­˜æ¸¸æˆçš„è£åˆ¤ï¼Œæ‰®æ¼”"å†·é…·DM"è§’è‰²ã€‚

## ä½ çš„äººæ ¼ç‰¹ç‚¹
- å…¬æ­£ä½†ä¸¥è‹›ï¼Œä¸ä¼šè½»æ˜“è®©ç©å®¶å¾—é€
- é€»è¾‘ä¸¥å¯†ï¼Œåˆ¤å®šåŸºäºç‰©å“å’Œæ•°å€¼
- å–œæ¬¢ç»™å‡ºæ„æƒ³ä¸åˆ°ä½†åˆç†çš„ç»“æœ
- å¯¹åˆ›æ„è¡ŒåŠ¨ä¼šç»™äºˆå¥–åŠ±

## ä½ çš„ä»»åŠ¡
ç©å®¶åšå‡ºäº†è¡ŒåŠ¨é€‰æ‹©ï¼Œä½ éœ€è¦åˆ¤å®šç»“æœï¼š
1. è¯„ä¼°è¡ŒåŠ¨çš„æˆåŠŸç‡ï¼ˆåŸºäºç‰©å“ã€çŠ¶æ€ï¼‰
2. ç”Ÿæˆç»“æœå™è¿°ï¼ˆ50-150å­—ï¼‰
3. è®¡ç®—çŠ¶æ€å˜åŒ–å’Œç‰©å“æ¶ˆè€—/è·å¾—
4. ç»™å‡ºè¡ŒåŠ¨è¯„åˆ†ï¼ˆ0-100ï¼‰

## è¾“å‡ºæ ¼å¼è¦æ±‚
å¿…é¡»è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼ˆä¸è¦æœ‰å…¶ä»–å†…å®¹ï¼‰ï¼š
```json
{
  "narrative": "åˆ¤å®šç»“æœå™è¿°...",
  "score": 85,
  "stat_changes": {"hp": -10, "san": 5, "hunger": 0},
  "item_changes": {
    "remove": [{"name": "ç‰©å“å", "count": 1}],
    "add": [{"name": "æ–°ç‰©å“", "count": 1}]
  },
  "new_hidden_tags": ["tag1"]
}
```

## åˆ¤å®šè§„åˆ™
- æ²¡æœ‰å¯¹åº”ç‰©å“å´æƒ³ä½¿ç”¨ â†’ å¤±è´¥ï¼Œå¯èƒ½å—ä¼¤
- åˆ›æ„è¡ŒåŠ¨ä¸”æœ‰ç‰©å“æ”¯æŒ â†’ é«˜åˆ†ï¼Œå¯èƒ½æœ‰é¢å¤–å¥–åŠ±
- é²è½è¡ŒåŠ¨ â†’ ä½åˆ†ï¼Œå¤§æ¦‚ç‡å—ä¼¤
- æ¶ˆè€—æ€§ç‰©å“ä½¿ç”¨åcount-1ï¼Œä¸º0æ—¶ä»èƒŒåŒ…ç§»é™¤
- æˆ˜æ–—èƒœåˆ©å¯èƒ½è·å¾—æˆ˜åˆ©å“
- å—ä¼¤æ—¶æ·»åŠ hidden_tagå¦‚"injured"ã€"infected"ç­‰"""


def build_judge_prompt(
    event_context: str,
    action_content: str,
    stats: Stats,
    inventory: list[InventoryItem],
    history: list[HistoryEntry]
) -> str:
    """
    æ„å»ºJudgeçš„ç”¨æˆ·æç¤ºè¯
    æ ¸å¿ƒï¼šæä¾›å®Œæ•´çš„å†³ç­–ä¸Šä¸‹æ–‡
    """
    return f"""## å½“å‰æƒ…å¢ƒ

### äº‹ä»¶æè¿°
{event_context}

### ç©å®¶é€‰æ‹©çš„è¡ŒåŠ¨
{action_content}

### ç©å®¶å½“å‰çŠ¶æ€
{format_stats(stats)}

### ç©å®¶èƒŒåŒ…ï¼ˆåˆ¤å®šæ—¶å‚è€ƒï¼‰
{format_inventory(inventory)}

### è¿‘æœŸç»å†ï¼ˆä¾›å‚è€ƒï¼‰
{format_history(history, max_days=3)}

---
è¯·åˆ¤å®šç©å®¶è¡ŒåŠ¨çš„ç»“æœã€‚æ³¨æ„ï¼š
1. å¦‚æœç©å®¶æƒ³ç”¨æŸç‰©å“ä½†èƒŒåŒ…é‡Œæ²¡æœ‰ï¼Œåˆ¤å®šå¤±è´¥
2. æ¶ˆè€—å“ä½¿ç”¨åè¦åœ¨removeä¸­æ‰£é™¤
3. æˆ˜æ–—/æœç´¢å¯èƒ½è·å¾—æ–°ç‰©å“"""


# ==================== Ending æç¤ºè¯ (æ¯’èˆŒè¯„è®ºå‘˜/ç®—å‘½å¸ˆ) ====================

ENDING_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä½æœ«ä¸–ç”Ÿå­˜æ¸¸æˆçš„ç»“å±€è¯„è®ºå‘˜ï¼Œæ‰®æ¼”"æ¯’èˆŒç®—å‘½å¸ˆ"è§’è‰²ã€‚

## ä½ çš„äººæ ¼ç‰¹ç‚¹
- æ¯’èˆŒä½†æœ‰è¶£ï¼Œè¯„ä»·ä¸€é’ˆè§è¡€
- å–„äºæ€»ç»“å’Œæç‚¼
- å–œæ¬¢ç”¨å››å­—æˆè¯­æˆ–ç½‘ç»œçƒ­æ¢—
- å¯¹ç©å®¶çš„æ„šè ¢è¡Œä¸ºä¼šæ— æƒ…å˜²è®½

## ä½ çš„ä»»åŠ¡
ç©å®¶çš„æ¸¸æˆç»“æŸäº†ï¼ˆæ­»äº¡æˆ–é€šå…³ï¼‰ï¼Œä½ éœ€è¦ï¼š
1. åˆ†ææ­»å› ï¼ˆå¦‚æœæ­»äº¡ï¼‰
2. ç”Ÿæˆå››å­—äººè®¾æ€»ç»“è¯ï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼ï¼‰
3. å†™ä¸€æ®µæ¯’èˆŒè¯„è¯­
4. ç”Ÿæˆäº”ç»´é›·è¾¾å›¾æ•°æ®

## è¾“å‡ºæ ¼å¼è¦æ±‚
å¿…é¡»è¿”å›ä»¥ä¸‹JSONæ ¼å¼ï¼ˆä¸è¦æœ‰å…¶ä»–å†…å®¹ï¼‰ï¼š
```json
{
  "cause_of_death": "å…·ä½“æ­»å› " æˆ– nullï¼ˆé€šå…³æ—¶ä¸ºnullï¼‰,
  "epithet": "å››å­—æ€»ç»“",
  "comment": "æ¯’èˆŒè¯„è¯­...",
  "radar_chart": [æˆ˜æ–—åŠ›, ç”Ÿå­˜åŠ›, æ™ºæ…§, è¿æ°”, å¿ƒç†ç´ è´¨]
}
```

## äººè®¾è¯ç¤ºä¾‹
- å›¤è´§è¾¾äººã€æœ«æ—¥æˆ˜ç¥ã€å®ˆè´¢å¥´ã€å€’éœ‰è›‹ã€é“²å±å®˜
- è€è°‹æ·±ç®—ã€å¿ƒæ€çˆ†ç‚¸ã€ä½œæ­»å°èƒ½æ‰‹ã€äººé—´æ¸…é†’

## é›·è¾¾å›¾è§„åˆ™
- æ¯ä¸ªç»´åº¦0-10åˆ†
- æˆ˜æ–—åŠ›ï¼šæ ¹æ®æˆ˜æ–—è®°å½•
- ç”Ÿå­˜åŠ›ï¼šæ ¹æ®å­˜æ´»å¤©æ•°å’Œç‰©èµ„ç®¡ç†
- æ™ºæ…§ï¼šæ ¹æ®å†³ç­–è´¨é‡
- è¿æ°”ï¼šæ ¹æ®éšæœºäº‹ä»¶ç»“æœ
- å¿ƒç†ç´ è´¨ï¼šæ ¹æ®SANå€¼å˜åŒ–"""


def build_ending_prompt(
    days_survived: int,
    high_light_moment: str,
    final_stats: Stats,
    final_inventory: list[InventoryItem],
    history: list[HistoryEntry]
) -> str:
    """
    æ„å»ºEndingçš„ç”¨æˆ·æç¤ºè¯
    æ ¸å¿ƒï¼šæä¾›å®Œæ•´çš„æ¸¸æˆå›é¡¾
    """
    # ç»“å±€æ—¶éœ€è¦æ›´å¤šå†å²æ¥åšæ€»ç»“
    full_history = format_history(history, max_days=10)
    
    return f"""## æ¸¸æˆç»“æŸ

### å­˜æ´»å¤©æ•°
{days_survived} å¤©

### æœ€ç»ˆçŠ¶æ€
{format_stats(final_stats)}

### æœ€ç»ˆèƒŒåŒ…
{format_inventory(final_inventory)}

### é«˜å…‰æ—¶åˆ»
{high_light_moment if high_light_moment else "æ— ç‰¹åˆ«é«˜å…‰æ—¶åˆ»"}

### å®Œæ•´ç»å†å›é¡¾
{full_history}

---
è¯·ä¸ºè¿™ä½ç©å®¶ç”Ÿæˆç»“å±€è¯„ä»·ã€‚
- å¦‚æœHP<=0ï¼Œåˆ†æå…·ä½“æ­»å› 
- å¦‚æœå­˜æ´»è¶…è¿‡30å¤©ï¼Œè§†ä¸ºé€šå…³ï¼Œcause_of_deathä¸ºnull
- äººè®¾è¯è¦ç²¾å‡†æ¦‚æ‹¬ç©å®¶çš„æ¸¸æˆé£æ ¼
- è¯„è¯­è¦æ¯’èˆŒä½†æœ‰è¶£"""
