# 末世模拟器：丧尸围城篇 - 游戏逻辑汇总文档

## 📋 目录
1. [游戏概述](#游戏概述)
2. [核心机制](#核心机制)
3. [游戏流程](#游戏流程)
4. [AI角色系统](#ai角色系统)
5. [数据结构](#数据结构)
6. [前后端协作](#前后端协作)
7. [状态更新规则](#状态更新规则)

---

## 游戏概述

### 游戏定位
一款 AI 驱动的文字生存 Roguelike 游戏，面向 H5 网页端（桌面端和移动端）。

### 核心体验
- **重生逆袭爽感**：玩家作为"重生者"，拥有先知优势
- **资源管理焦虑**：有限的金钱、空间和物资需要精打细算
- **AI 自由叙事**：每次游戏都有独特的剧情体验
- **社交裂变分享**：结局卡片生成，包含"四字人设词"和战绩数据

### 世界观设定
- **时间线**：现代都市，丧尸病毒突然爆发
- **玩家身份**：重生者——在前世被丧尸咬死后，意识回到了末日爆发前3天
- **核心冲突**：利用先知优势囤积物资，在避难所中艰难求生
- **氛围基调**：紧张、压抑、偶有黑色幽默，强调资源匮乏带来的焦虑感

### 社会崩溃时间线
- **第1-3天**：丧尸突然爆发，90%的人变成了丧尸
- **第4-10天**：完全停水停电，网络彻底断，大部分幸存者家中食物水源消耗殆尽不得不外出寻找食物，聚集地开始形成
- **第11-20天**：部分丧尸出现功能性变异（攀爬丧尸、疾跑丧尸）
- **第21-30天**：军队进驻城市，开始清扫丧尸

---

## 核心机制

### 1. 双维属性系统

#### ❤️ 生命 (HP)
- **范围**：0-100
- **归零条件**：死亡，游戏结束
- **影响因素**：
  - 受伤/被攻击：轻伤 -5~-20，重伤 -20~-80，致命伤直接归零
  - 治疗/使用药品：+10~+30（根据药品类型）
  - 生病/感染：持续下降，需添加对应标签
  - 休息/恢复：+5~+10

#### 🧠 理智 (SAN)
- **范围**：0-100
- **影响因素**：
  - 恐惧/压力事件：-5~-15
  - 目睹惨状/杀人：-10~-20
  - 娱乐/宠物互动：+5~+15
  - 安全感/好消息：+5~+10
  - 长期隔离：每天 -3~-5
- **特殊效果**：
  - SAN < 30：叙事出现幻觉、偏执描写，触发视觉特效（血色滤镜）
  - SAN < 10：可能出现自残、攻击同伴等极端选项

### 2. 背包系统

#### 物品分类
- **消耗品**：食物、水、药品（使用后消失）
- **工具**：武器、工具（可重复使用，但可能损坏）
- **情绪物品**：宠物、娱乐品（提供 SAN 恢复，是"奢侈品"）
- **特殊物品**：钥匙、地图等剧情道具

#### 空间限制
- 背包空间由避难所决定
- 每个物品占用一定格数
- 超出空间无法购买/拾取

### 3. 避难所系统

#### 三种避难所
1. **出租屋**
   - 价格：¥2000
   - 空间：50格
   - 防御：★（1级）
   - 特点：拥挤的单间，适合不想花钱的赌徒
   - 隐藏属性：人口密度高，易遭丧尸围堵；防盗门质量差；隔音差

2. **地下室**
   - 价格：¥4000
   - 空间：80格
   - 防御：★★（2级）
   - 特点：阴暗水泥房，压抑易抑郁
   - 隐藏属性：有一定隔音效果；防盗门质量一般

3. **半山别墅**
   - 价格：¥8000
   - 空间：150格
   - 防御：★★★（3级）
   - 特点：带落地窗和围栏的豪宅，易招惹强盗
   - 隐藏属性：有游泳池可取水；2m高围栏；内置娱乐设施

#### 避难所影响
- **防御等级**：影响被袭击概率和抵御能力
- **空间限制**：决定能携带多少物资
- **隐藏属性**：每个避难所有独特的剧情触发条件（玩家不可见，仅供 AI 参考）

### 4. 隐藏标签系统

#### 标签用途
- **持续状态**：`<受伤>`、`<被吓到了>`、`<感染>`
- **剧情标记**：`<暗中有幸存者团体密谋对玩家不利>`
- **物品状态**：`<枪支损坏，强行使用可能炸膛>`

#### 标签特性
- 玩家不可见，仅供 AI 参考
- 影响后续剧情生成和判定结果
- 可以被添加或移除

---

## 游戏流程

### 阶段一：重生觉醒（Home.vue）
- 纯文字演出，玩家重生回末世前3天
- 介绍游戏背景和玩家身份
- 点击开始进入下一阶段

### 阶段二：物资筹备（Market.vue）
- **时间限制**：3分钟倒计时
- **初始资金**：¥10,000

#### 操作流程
1. **选择避难所**（必选）
   - 影响后续空间和防御
   - 扣除相应金额

2. **购买物资**
   - 按分类浏览：全部/食物/武器/医疗/情绪
   - 点击商品加入购物车
   - 实时显示剩余金钱和空间

3. **结束购物**
   - 倒计时结束自动进入生存阶段
   - 或手动点击"开始生存"按钮

#### 商品列表
**食物类**：压缩饼干、桶装水、罐头、方便面
**武器类**：棒球棍、水果刀、霰弹枪、霰弹
**医疗类**：绷带、抗生素、急救包
**情绪类**：橘猫、Switch游戏机、老干妈、小说、香烟、红酒

### 阶段三：生存循环（Survival.vue）

#### 回合机制
每一天相当于一个回合，流程如下：

1. **AI 生成今日剧情**（Narrator）
   - 流式输出叙事内容
   - 判断是否触发危机事件
   - 如果无危机，直接更新状态并进入下一天
   - 如果有危机，生成 A/B/C/D 四个选项

2. **玩家做出决策**（如果有危机）
   - 选择预设选项 A/B/C/D
   - 或自由输入行动（E选项）

3. **AI 判定行动结果**（Judge）
   - 流式输出判定叙事
   - 计算状态变化和物品消耗
   - 评分 0-100 分

4. **更新游戏状态**
   - 应用属性变化
   - 更新背包物品
   - 添加/移除隐藏标签
   - 记录历史

5. **检查结束条件**
   - HP ≤ 0：死亡，进入结局
   - 天数 > 30：通关，进入结局
   - 否则进入下一天

#### 危机事件触发逻辑
- 不是每天都有危机，大约 40-60% 的天数会触发
- 早期（1-3天）：危机较少，让玩家适应
- 中后期：危机频率和烈度上升
- 物资充足时可以安排"平静的一天"
- 物资匮乏或状态危险时，危机更容易出现

### 阶段四：结局结算（Ending.vue）

#### 结局触发条件
- **死亡结局**：HP ≤ 0
- **通关结局**：存活 > 30 天

#### 结局内容
1. **死因分析**（如果死亡）：具体死亡原因
2. **人设词**：三到六个字的总结词（核心！）
3. **毒舌评语**：50-100字的犀利点评
4. **五维雷达图**：战斗力、生存力、智慧、运气、心理素质（各0-10分）
5. **分享卡片**：可导出为图片分享

---

## AI角色系统

### 角色一：Narrator（小说家/旁白）

#### 职责
1. 生成每日生存日志（流式输出）
2. 决定是否触发危机事件
3. 设计 A/B/C/D 选项
4. 在无危机事件时，同时输出状态更新

#### 人格特质
- **写作风格**：第二人称视角（"你"），日记体/生存手记风格
- **叙事原则**：前后连贯，状态驱动，物品关联，适度留白
- **情绪基调映射**：
  - SAN > 70：正常叙事，偶有希望
  - SAN 30-70：略带压抑，开始出现不安暗示
  - SAN < 30：幻觉、偏执、不可靠叙述者
  - SAN < 10：意识流、破碎叙事、分不清现实与幻觉

#### 输出格式

**无危机事件时**：
```
[日志正文...]

<state_update>
{"stat_changes": {"hp": 0, "san": 5}, "item_changes": {"remove": [], "add": []}, "new_hidden_tags": [], "remove_hidden_tags": []}
</state_update>
```

**有危机事件时**：
```
[日志正文...]

<options>
A. 选项1描述
B. 选项2描述
C. 选项3描述
D. 选项4描述
</options>

<hidden>
A、B选项是致死选项。
</hidden>
```

#### 选项设计原则
- 选项要基于玩家当前拥有的物品
- 包含不同风险等级：保守/冒险/创意
- 避免明显的"正确答案"，每个选项都有代价
- 可以设计道德困境（如：救人还是保命）

### 角色二：Judge（冷酷裁判/DM）

#### 职责
1. 判定玩家行动的结果（流式输出）
2. 同时输出状态更新和行动评分

#### 人格特质
- **判定风格**：公正但严苛，不会因为玩家"想要"成功就让他成功
- **判定原则**：
  1. 物品决定论：没有对应物品却想使用 → 必定失败
  2. 风险收益：高风险行动可能高回报，也可能惨败
  3. 连锁反应：行动可能引发意想不到的后果
  4. 世界一致性：判定结果要符合末世设定

#### 输出格式
```
[判定叙事正文...]

<state_update>
{"score": 75, "stat_changes": {"hp": -10, "san": -5}, "item_changes": {"remove": [{"name": "棒球棍", "count": 1}], "add": []}, "new_hidden_tags": ["受伤"], "remove_hidden_tags": []}
</state_update>
```

#### 评分标准
- **90-100**：神级操作，创意满分且完美执行
- **70-89**：优秀决策，合理利用资源
- **50-69**：中规中矩，完成目标但有代价
- **30-49**：勉强过关，付出较大代价
- **0-29**：糟糕决策，严重后果

### 角色三：Ending（毒舌评论员/算命师）

#### 职责
1. 分析死因（如果死亡）
2. 生成四字人设词
3. 写毒舌评语
4. 生成五维雷达图数据

#### 人格特质
- **说话风格**：毒舌但有趣，评价一针见血
- **评价原则**：基于事实，个性化，可分享性，平衡感

#### 人设词示例
- **正面类**：末日战神、囤货达人、人间清醒、求生专家
- **负面类**：作死小能手、守财奴、倒霉蛋
- **特色类**：铲屎官、美食家

#### 雷达图评分规则
1. **战斗力**：基于战斗次数和胜率
2. **生存力**：基于存活天数（1-3天=1~3分，30天+=10分）
3. **智慧**：基于决策质量（Judge评分平均值）
4. **运气**：基于随机事件结果
5. **心理素质**：基于SAN值管理

---

## 数据结构

### 前端类型定义（TypeScript）

```typescript
// 玩家状态
interface Stats {
  hp: number      // 生命值 0-100
  san: number     // 理智值 0-100
}

// 背包物品
interface InventoryItem {
  name: string
  count: number
}

// 历史记录条目
interface HistoryEntry {
  day: number
  log: string                    // Narrator 生成的今日事件描述
  player_action?: string | null  // 玩家选择的行动（有危机事件时）
  judge_result?: string | null   // Judge 的判定叙事（有危机事件时）
  event_result: string           // 事件结果：success/fail/none
}

// 商品定义
interface ShopItem {
  id: string
  name: string
  price: number
  space: number      // 占用空间
  category: 'food' | 'weapon' | 'medical' | 'emotional'
  description: string
  icon: string
}

// 避难所定义
interface Shelter {
  id: string
  name: string
  price: number
  space: number      // 提供空间
  defense: number    // 防御等级 1-3
  description: string
  hidden_discription: string // 向用户隐藏的说明
}
```

### 后端模型定义（Python/Pydantic）

与前端类型定义保持一致，使用 Pydantic 进行请求/响应验证。

---

## 前后端协作

### 架构原则
- **前端负责所有游戏逻辑和状态**
- **后端是无状态的 LLM 代理**
- 前端维护所有游戏状态，后端仅根据输入生成叙事和判定

### API 接口

#### 1. POST /api/game/narrate/stream
**功能**：每日剧情生成（流式输出）

**请求体**：
```json
{
  "day": 1,
  "stats": {"hp": 100, "san": 100},
  "inventory": [{"name": "压缩饼干", "count": 5}],
  "hidden_tags": [],
  "history": [],
  "shelter": {...}
}
```

**响应**：SSE 流式输出
- `type: "content"`：叙事文本片段
- `type: "done"`：流式完成

**前端解析**：
- 从完整输出中提取 `<state_update>` 标签（无危机时）
- 或提取 `<options>` 标签（有危机时）

#### 2. POST /api/game/judge/stream
**功能**：行动判定（流式输出）

**请求体**：
```json
{
  "day": 1,
  "event_context": "今日事件描述...",
  "action_content": "玩家选择的行动",
  "stats": {...},
  "inventory": [...],
  "history": [...]
}
```

**响应**：SSE 流式输出
- `type: "content"`：判定叙事文本片段
- `type: "done"`：流式完成

**前端解析**：
- 从完整输出中提取 `<state_update>` 标签
- 包含 `score` 和状态变化

#### 3. POST /api/game/ending
**功能**：结局结算（非流式）

**请求体**：
```json
{
  "days_survived": 15,
  "high_light_moment": "第10天: ...",
  "final_stats": {...},
  "final_inventory": [...],
  "history": [...]
}
```

**响应**：
```json
{
  "cause_of_death": "被丧尸咬死" | null,
  "epithet": "作死小能手",
  "comment": "你的末日之旅...",
  "radar_chart": [7, 5, 6, 3, 4]
}
```

### 流式输出处理

#### 前端实现
```typescript
// 流式获取叙事内容
let fullText = "";
for await (const chunk of narrateStream({...})) {
  fullText += chunk;
  // 实时过滤隐藏标签，避免展示给玩家
  displayText = filterHiddenContent(fullText);
}

// 解析完整输出
const parsed = parseNarrativeChoices(fullText);
```

#### 标签过滤
- `<hidden>` 标签：仅供 Judge 参考，前端不展示
- `<state_update>` 标签：前端解析后应用状态，不展示原始 JSON

---

## 状态更新规则

### 状态变化触发条件

#### HP（生命）
- 受伤/被攻击：轻伤 -5~-20，重伤 -20~-80，致命伤直接归零
- 治疗/使用药品：+10~+30
- 生病/感染：持续下降，需添加对应标签
- 休息/恢复：+5~+10

#### SAN（理智）
- 恐惧/压力事件：-5~-15
- 目睹惨状/杀人：-10~-20
- 娱乐/宠物互动：+5~+15
- 安全感/好消息：+5~+10
- 长期隔离：每天 -3~-5

### 物品变化规则
- **消耗品**（食物、药品、弹药）：使用后必须在 `remove` 中扣除
- **工具类**（武器、工具）：通常不消耗，但可能损坏（添加标签）
- **获得新物品**：放在 `add` 中
- **叙事未提及的物品**：`remove` 和 `add` 保持空数组

### 隐藏标签变更规则
- `new_hidden_tags`：新增的标签（如受伤、感染等新状态）
- `remove_hidden_tags`：需要移除的标签
- 只有当状态确实改变时才添加/移除标签
- 移除标签时必须使用与现有标签完全相同的字符串

### 状态更新 JSON 格式

```json
{
  "stat_changes": {
    "hp": 0,
    "san": 5
  },
  "item_changes": {
    "remove": [],
    "add": []
  },
  "new_hidden_tags": [],
  "remove_hidden_tags": []
}
```

**Judge 额外字段**：
```json
{
  "score": 75,
  "stat_changes": {...},
  "item_changes": {...},
  "new_hidden_tags": [...],
  "remove_hidden_tags": [...]
}
```

---

## 状态管理（Pinia）

### gameStore
**核心游戏状态**，包含：
- `day`：当前天数
- `stats`：玩家属性（HP/SAN/Hunger）
- `inventory`：背包物品列表
- `hiddenTags`：隐藏标签列表
- `history`：历史记录
- `money`：金钱
- `shelter`：选择的避难所
- `highLightMoment`：高光时刻

**计算属性**：
- `usedSpace`：已用空间
- `maxSpace`：最大空间
- `remainingSpace`：剩余空间
- `isGameOver`：是否死亡
- `isVictory`：是否通关

**方法**：
- `resetGame()`：重置游戏
- `selectShelter()`：选择避难所
- `addItem()` / `removeItem()`：物品管理
- `updateStats()`：更新属性
- `addHistory()`：添加历史记录
- `addHiddenTag()` / `removeHiddenTag()`：标签管理
- `setHighLight()`：设置高光时刻
- `nextDay()`：进入下一天

**持久化**：使用 `pinia-plugin-persistedstate` 自动保存到 localStorage

### uiStore
**UI 状态**，包含：
- `isLoading`：是否正在加载
- `currentLogText`：当前显示的日志文本
- `showChoices`：是否显示选项
- `choices`：当前选项列表
- `soundEnabled`：是否启用音效
- `showGlitch`：是否显示故障效果

---

## 特殊机制

### 1. 低 SAN 值视觉效果
- SAN < 30：触发血色滤镜和更阴暗的叙事
- SAN < 10：意识流、破碎叙事、分不清现实与幻觉

### 2. 高光时刻记录
- Judge 评分 ≥ 90 时自动记录
- 用于结局评价和分享卡片

### 3. 历史记录结构
每条历史记录包含：
- `day`：天数
- `log`：Narrator 生成的今日事件描述
- `player_action`：玩家选择的行动（有危机时）
- `judge_result`：Judge 的判定叙事（有危机时）
- `event_result`：事件结果（success/fail/none）

### 4. 避难所隐藏属性
- 玩家不可见，仅在 `hidden_discription` 字段中
- 供 AI 参考，用于设计剧情
- 例如：出租屋隔音差，发出声音时会吸引丧尸

---

## 技术栈

### 前端
- **框架**：Vue 3（Composition API + `<script setup>`）
- **语言**：TypeScript（严格模式）
- **构建工具**：Vite 5
- **路由**：Vue Router 4
- **状态管理**：Pinia + pinia-plugin-persistedstate
- **样式**：Tailwind CSS
- **HTTP**：原生 fetch + SSE 流式传输
- **图片导出**：html2canvas

### 后端
- **框架**：FastAPI
- **语言**：Python 3.12+
- **数据验证**：Pydantic v2 + pydantic-settings
- **LLM 客户端**：OpenAI SDK（异步）
- **服务器**：Uvicorn

---

## 设计原则

### 1. 前端主导
- 游戏逻辑和数值全部放在前端
- 后端仅作为无状态的 LLM 代理
- 前端维护所有游戏状态

### 2. 状态持久化
- Pinia 状态持久化（localStorage）
- 支持存档/续玩

### 3. 流式输出
- 提升用户体验，实时展示叙事
- 避免长时间等待

### 4. 标签系统
- 隐藏标签影响剧情走向
- 玩家不可见，增加神秘感

### 5. AI 自由度
- AI 决定危机事件触发
- AI 设计选项和判定结果
- 每次游戏都有独特体验

---

## 结束条件

### 死亡结局
- HP ≤ 0
- 触发条件：受伤、饥饿、感染、被杀等

### 通关结局
- 存活 > 30 天
- 军队进驻，城市恢复秩序

---

## 总结

《末世模拟器：丧尸围城篇》是一款以 AI 驱动叙事为核心的文字生存游戏。通过三个 AI 角色（Narrator、Judge、Ending）的协作，为玩家提供独特的末世生存体验。游戏采用双维属性系统（HP 和 SAN），强调资源管理、决策权衡和心理压力，每次游戏都有不同的剧情走向和结局。

核心设计理念：
- **前端主导**：所有游戏逻辑在前端，后端仅提供 AI 叙事
- **流式体验**：实时展示叙事，提升沉浸感
- **状态驱动**：玩家的 HP 和 SAN 属性影响剧情走向
- **AI 自由度**：每次游戏都有独特体验
- **社交裂变**：结局卡片分享，增加传播性

---

**文档版本**：v1.0  
**最后更新**：2025-12-14
